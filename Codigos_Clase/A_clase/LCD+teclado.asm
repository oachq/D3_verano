	; LCD 8 bits + teclado 
	
	LIST	P=18F4550
	#INCLUDE	<P18F4550.INC>

	CONFIG FOSC=INTOSCIO_EC
	CONFIG PWRT=ON
	CONFIG BOR=OFF
	CONFIG LVP=OFF
	CONFIG MCLRE=OFF
	CONFIG WDT=OFF
	CONFIG DEBUG=OFF
	CONFIG CP0=OFF
	CONFIG CP1=OFF
	CONFIG CPB=OFF
	CONFIG PBADEN=OFF

	#DEFINE	LCD	LATD
	#DEFINE	RS	LATC,4
	#DEFINE	RW	LATC,5
	#DEFINE	E	LATC,6

	CBLOCK	0X20
	TEMP
	MILI
	MILI2
	TECLA
	CNT
	DIRV
	ENDC
	
	ORG	0X0000
	GOTO INICIO
	
	ORG	0X0018
	GOTO INICIO

CPORTS
	MOVLW	0X0F
	MOVWF	ADCON1
	MOVLW	0X07
	MOVWF	CMCON
	MOVLW	0X62
	MOVWF	OSCCON
	MOVLW	0XF0
	MOVWF	TRISB
	CLRF	TRISD
	CLRF	TRISC
	CLRF	LCD
	CLRF	LATB
	BCF		RS
	BCF		RW
	BCF		E
	RETURN
ANTIR		;ANTIRREBOTE

		BTFSC	PORTB,4		;C1
		BRA		ANTIR
SIG		BTFSC	PORTB,5		;C2
		BRA		SIG
SIG2	BTFSC	PORTB,6		;C3
		BRA		SIG2
SIG3	BTFSC	PORTB,7		;C4
		BRA		SIG3	
		RCALL	DECODE
		RCALL	SEND_CHAR
		INCF	CNT,F
		MOVF	CNT,W
		SUBLW	.16
		BZ		ODIR
		BRA		NEW
ODIR	
		CLRF	CNT
		MOVF	DIRV,W
		SUBLW	0X80
		BZ		LIN2
		MOVLW	0X01
		RCALL	SEND_CMD
		MOVLW	0X80
		RCALL	SEND_CMD
		BRA		NEW
LIN2
		MOVLW	0XC0
		MOVWF	DIRV
		RCALL	SEND_CMD
		BRA		NEW
DECODE	
	RLNCF	TECLA,W
	ADDWF	PCL,F
	RETLW	'0'
	RETLW	'1'
	RETLW	'2'
	RETLW	'3'
	RETLW	'4'
	RETLW	'5'
	RETLW	'6'
	RETLW	'7'
	RETLW	'8'
	RETLW	'9'
	RETLW	'A'
	RETLW	'B'
	RETLW	'C'
	RETLW	'D'
	RETLW	'E'
	RETLW	'F'


CLCD
	MOVLW	0X38
	RCALL	SEND_CMD
	MOVLW	0X0C
	RCALL	SEND_CMD
	MOVLW	0X06
	RCALL	SEND_CMD
	MOVLW	0X01
	RCALL	SEND_CMD
	RETURN

SEND_CMD
	BCF		RS
NEXT	MOVWF	TEMP
	MOVLW	.5
	MOVWF	MILI
	RCALL	RETARDO
	MOVF	TEMP,W
	MOVWF	LCD
	BSF		E
	BCF		E
	RETURN
SEND_CHAR
	BSF		RS
	BRA		NEXT

RETARDO
	MOVLW	0XF9
	MOVWF	MILI2
	NOP
OT	DECFSZ	MILI2,F
	BRA		OT
	DECFSZ	MILI,F
	BRA		RETARDO
	RETURN
INICIO
	RCALL	CPORTS
	RCALL	CLCD
	MOVLW	0X80
	MOVWF	DIRV
	RCALL	SEND_CMD
NEW	MOVLW	0X01
	MOVWF	LATB
	CLRF	TECLA
CHK	BTFSC	PORTB,4
	BRA		ANTIR
	INCF	TECLA,F	
	BTFSC	PORTB,5
	BRA		ANTIR
	INCF	TECLA,F
	BTFSC	PORTB,6
	BRA		ANTIR
	INCF	TECLA,F	
	BTFSC	PORTB,7
	BRA		ANTIR
	INCF	TECLA,F
	MOVLW	.16
	SUBWF	TECLA,W
	BTFSC	STATUS,Z
	BRA		NEW
	BCF		STATUS,C
	RLCF	LATB,F
	BRA		CHK
	END 
	BRA		$
	END